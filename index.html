// server.js

// 1. Erforderliche Pakete importieren
const express = require('express');
const { OpenAI } = require('openai'); // Das offizielle OpenAI-Paket
require('dotenv').config(); // Um Umgebungsvariablen aus .env zu laden
const cors = require('cors'); // Um Cross-Origin-Requests zu erlauben

// 2. Express-App initialisieren
const app = express();
const port = 3000; // Der Port, auf dem unser Server laufen wird

// 3. Middleware
app.use(express.json()); // Erlaubt der App, JSON-Anfragen zu parsen
app.use(cors()); // Erlaubt Anfragen von deinem Frontend (index.html) an diesen Server

// 4. OpenAI-Client initialisieren
// Der API-Key wird sicher aus den Umgebungsvariablen geladen
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// 5. Route für die Chat-Anfragen erstellen
app.post('/chat', async (req, res) => {
  const userMessage = req.body.message; // Die Nachricht, die vom Frontend gesendet wurde

  if (!userMessage) {
    return res.status(400).json({ error: 'Nachricht fehlt im Request-Body.' });
  }

  try {
    // Anfrage an die OpenAI API senden
    const completion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo", // Oder ein anderes Modell wie "gpt-4" wenn verfügbar
      messages: [
        { role: "system", content: "Du bist Lucifer, ein hilfreicher und informativer Chatbot. Antworte ausführlich und umfassend, aber bleibe höflich und themenbezogen." },
        { role: "user", content: userMessage }
      ],
      max_tokens: 300, // Maximale Länge der Antwort in Tokens (Wörter/Teile)
      temperature: 0.7, // Kreativität der Antwort (0.0 = sehr faktenbasiert, 1.0 = sehr kreativ)
    });

    const aiReply = completion.choices[0].message.content;
    res.json({ reply: aiReply }); // Sende die Antwort zurück an das Frontend

  } catch (error) {
    console.error("Fehler bei der OpenAI-Anfrage:", error);
    if (error.response) {
      console.error("OpenAI API Fehlerantwort:", error.response.status, error.response.data);
    }
    res.status(500).json({ error: "Ein Fehler ist bei der Verarbeitung deiner Anfrage aufgetreten." });
  }
});

// 6. Server starten
app.listen(port, () => {
  console.log(`Server läuft auf http://localhost:${port}`);
  console.log("Stellen Sie sicher, dass Ihr OpenAI API Key in der .env Datei gesetzt ist.");
});
